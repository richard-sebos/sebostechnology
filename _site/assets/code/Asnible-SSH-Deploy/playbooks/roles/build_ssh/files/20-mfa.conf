# ==============================================================================
# 20-mfa.conf â€” Enforce MFA: public key + OTP (PAM/keyboard-interactive)
#
# Purpose:
#   Require two factors for SSH logins:
#     1) PubkeyAuthentication (something you have)
#     2) keyboard-interactive via PAM (e.g., TOTP from google-authenticator)
#
# Prereqs:
#   - PAM module installed & configured (example for OL/RHEL):
#       dnf install -y google-authenticator qrencode
#       # In /etc/pam.d/sshd (before common-account), add a line like:
#       #   auth required pam_google_authenticator.so nullok try_first_pass
#     Each user seeds OTP with `google-authenticator` (or your chosen PAM OTP).
#
# Notes:
#   - `AuthenticationMethods publickey,keyboard-interactive:pam` enforces BOTH.
#   - This fragment only manages MFA policy; base auth policy remains in
#     07-authentication.conf (PasswordAuthentication no, etc.).
#   - Exemption for automation (`ansible_admin`) is included below; remove it
#     if you want MFA for that account too (Ansible usually can't do OTP).
# ==============================================================================

UsePAM yes
PubkeyAuthentication yes
KbdInteractiveAuthentication yes
PasswordAuthentication no

# Require BOTH factors:
#   1) publickey
#   2) keyboard-interactive via PAM (e.g., google-authenticator)
AuthenticationMethods publickey,keyboard-interactive:pam

# Tighten auth behavior a bit (per-connection knobs)
MaxAuthTries 3
LoginGraceTime 30

# --- Optional exemptions (automation / break-glass) -----------------------------
# Exempt the Ansible automation user from OTP (key-only). Remove if not desired.
Match User ansible_admin
    AuthenticationMethods publickey
    KbdInteractiveAuthentication no
